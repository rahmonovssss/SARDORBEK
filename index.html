<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Milliy Sertifikat Bot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root { --bg: #121920; --card: #1c2329; --accent: #00b4d8; --border: #2d3842; --text: #ffffff; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
  .header { text-align: center; margin-bottom: 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
  .field-label { font-size: 14px; color: #aeb9c2; margin-bottom: 5px; display: block; text-align: left; }
  select, input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border); background: #0d1217; color: white; font-size: 16px; box-sizing: border-box; }
  .btn { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
  .btn:disabled { background: #444; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; background: var(--card); }
  th, td { border: 1px solid var(--border); padding: 10px 5px; text-align: center; }
  th { background: #252e37; font-size: 14px; }
  .opt-grid { display: flex; justify-content: center; gap: 8px; }
  .opt-item { position: relative; width: 24px; height: 24px; }
  .opt-item input { position: absolute; opacity: 0; cursor: pointer; width: 100%; height: 100%; margin: 0; z-index: 2; }
  .checkmark { position: absolute; top: 0; left: 0; height: 22px; width: 22px; background: transparent; border: 2px solid #55606a; border-radius: 50%; z-index: 1; }
  .opt-item input:checked ~ .checkmark { background: var(--accent); border-color: var(--accent); }
  .opt-item input:checked ~ .checkmark::after { content: ""; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; top: 7px; left: 7px; }
  .yopiq-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
  .yopiq-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
  .mini-btn { background: #2d3842; color: white; border: 1px solid #444; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
  .ans-label { font-size: 11px; color: #00b4d8; font-weight: bold; }
  .yopiq-field { background: #0d1217; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 5px; width: 90%; text-align: center; }
  .q-row-control { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; padding: 10px; background: #1c2329; border-radius: 8px; border: 1px dashed #444; }
  .hidden { display: none; }
  .timer { position: sticky; top: 0; background: #e63946; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px; z-index: 100; margin-bottom: 10px; }
  .subject-badge { background: #2a9d8f; color: white; padding: 5px 10px; border-radius: 5px; font-size: 14px; margin-top: 5px; display: inline-block; }
  .unanswered { border: 2px solid #ff4d4d !important; border-radius: 5px; }
</style>
</head>
<body>

<div id="main-container">
  <div class="header" id="title">Milliy Sertifikat Bot</div>
  <div id="solve-init" class="hidden">
    <div class="card">
      <span class="field-label">Test kodi</span>
      <input type="number" id="solve_test_code" placeholder="Kodni kiriting" />
      <button class="btn" onclick="startSolving()">OK</button>
    </div>
  </div>

  <div id="test-area" class="hidden">
    <div id="timer" class="timer hidden">03:00:00</div>
    <div id="info-bar" class="card" style="text-align: center; display: none;">
        <span id="display_subject" class="subject-badge"></span>
    </div>
    <div id="create-header" class="card hidden">
      <span class="field-label">Fanni tanlang</span>
      <select id="subject_select">
        <option value="" disabled selected>Fanni tanlang...</option>
        <option value="Matematika">Matematika</option>
        <option value="Fizika">Fizika</option>
        <option value="Ona tili va adabiyot">Ona tili va adabiyot</option>
        <option value="Kimyo">Kimyo</option>
        <option value="Biologiya">Biologiya</option>
        <option value="Tarix">Tarix</option>
      </select>
      <span class="field-label" style="margin-top:10px;">Test kodi</span>
      <input type="number" id="create_test_code" placeholder="Kodni kiriting">
    </div>
    
    <div id="questions_table"></div>

    <div id="global_q_control" class="q-row-control hidden">
        <button class="mini-btn" onclick="changeTotalQ(-1)" style="width: 40px; height: 40px; background: #e63946;">-</button>
        <span id="total_q_lbl" style="font-weight: bold;">45 ta savol</span>
        <button class="mini-btn" onclick="changeTotalQ(1)" style="width: 40px; height: 40px; background: #2a9d8f;">+</button>
    </div>

    <div style="margin: 20px 0;">
      <div id="error_msg" style="color: #ff4d4d; text-align: center; margin-bottom: 10px; display: none;">Balans yetarli emas!</div>
      <button class="btn" id="submit_btn" onclick="processData()">SAQLASH</button>
    </div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const urlParams = new URLSearchParams(window.location.search);
const mode = urlParams.get('mode') || 'create';
const userBalance = parseInt(urlParams.get('balance')) || 0;
const testCount = parseInt(urlParams.get('count')) || 0;

let testMap = {};
let currentTotalQ = 45;
let rowAnsCounts = {};
let savedState = {}; // Belgilangan javoblarni saqlab qolish uchun

try {
  const rawData = urlParams.get('test_data');
  if(rawData) testMap = JSON.parse(decodeURIComponent(rawData));
} catch(e) { console.error("Xato"); }

window.onload = () => {
  for(let i=36; i<=45; i++) rowAnsCounts[i] = 1;

  if (mode === 'create') {
    document.getElementById('title').innerText = "Test yaratish";
    document.getElementById('create-header').classList.remove('hidden');
    document.getElementById('global_q_control').classList.remove('hidden');
    document.getElementById('test-area').classList.remove('hidden');
    renderQuestions();
    if (testCount >= 1 && userBalance < 2000) {
        document.getElementById('submit_btn').disabled = true;
        document.getElementById('error_msg').style.display = 'block';
    }
  } else {
    document.getElementById('title').innerText = "Javob yuborish";
    document.getElementById('solve-init').classList.remove('hidden');
  }
};

function saveCurrentData() {
    for (let i = 1; i <= 45; i++) {
        if (i <= 35) {
            const sel = document.querySelector(`input[name="q${i}"]:checked`);
            savedState[`q${i}`] = sel ? sel.value : null;
        } else {
            let count = rowAnsCounts[i] || 1;
            for(let j=0; j<5; j++) {
                const el = document.getElementById(`ans${i}_${j}`);
                if(el) savedState[`ans${i}_${j}`] = el.value;
            }
        }
    }
}

function restoreData() {
    for (let i = 1; i <= currentTotalQ; i++) {
        if (i <= 35) {
            if(savedState[`q${i}`]) {
                const rad = document.querySelector(`input[name="q${i}"][value="${savedState[`q${i}`]}"]`);
                if(rad) rad.checked = true;
            }
        } else {
            let count = rowAnsCounts[i] || 1;
            for(let j=0; j<count; j++) {
                const el = document.getElementById(`ans${i}_${j}`);
                if(el && savedState[`ans${i}_${j}`]) el.value = savedState[`ans${i}_${j}`];
            }
        }
    }
}

function changeTotalQ(val) {
    saveCurrentData();
    let next = currentTotalQ + val;
    if (next >= 36 && next <= 45) {
        currentTotalQ = next;
        document.getElementById('total_q_lbl').innerText = currentTotalQ + " ta savol";
        renderQuestions();
        restoreData();
    }
}

function changeAnsCount(qNum, val) {
    saveCurrentData();
    let next = (rowAnsCounts[qNum] || 1) + val;
    if (next >= 1 && next <= 5) {
        rowAnsCounts[qNum] = next;
        renderQuestions();
        restoreData();
    }
}

function startSolving() {
  const code = document.getElementById('solve_test_code').value;
  if(!code) return alert("Kodni kiriting!");
  
  // Test ma'lumotlarini qabul qilish (Botdan kelgan keys strukturasini tekshirish)
  // Bu yerda logic: agar create qilinganda total yuborilgan bo'lsa, shuni olish kerak
  // Hozircha default botdan kelgan javoblarga qarab render qiladi
  
  document.getElementById('solve-init').classList.add('hidden');
  document.getElementById('test-area').classList.remove('hidden');
  document.getElementById('timer').classList.remove('hidden');
  document.getElementById('submit_btn').innerText = "YUBORISH";
  renderQuestions();
  startTimer();
}

function renderQuestions() {
  let html = `<table><tr><th>â„–</th><th>Variantlar</th></tr>`;
  for (let i = 1; i <= currentTotalQ; i++) {
    if (i <= 35) {
      const cols = i <= 32 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E', 'F'];
      html += `<tr id="row_${i}"><td><b>${i}</b></td><td><div class="opt-grid">`;
      cols.forEach(opt => {
        html += `<div class="opt-item"><input type="radio" name="q${i}" value="${opt}"><span class="checkmark"></span><span style="display:block; margin-top:25px; font-size:10px;">${opt}</span></div>`;
      });
      html += `</div></td></tr>`;
    } else {
      let count = rowAnsCounts[i] || 1;
      html += `<tr id="row_${i}"><td><b>${i}</b></td><td><div class="yopiq-wrapper">`;
      
      if(mode === 'create') {
          let label = count > 1 ? count + " ta Javob" : "Javob";
          html += `<div class="yopiq-controls">
                <button class="mini-btn" onclick="changeAnsCount(${i}, -1)">-</button>
                <span class="ans-label">${label}</span>
                <button class="mini-btn" onclick="changeAnsCount(${i}, 1)">+</button>
            </div>`;
      }
      
      for(let j=0; j<count; j++) {
        html += `<input type="text" class="yopiq-field" id="ans${i}_${j}" placeholder="Javob ${count > 1 ? j+1 : ''}">`;
      }
      html += `</div></td></tr>`;
    }
  }
  document.getElementById('questions_table').innerHTML = html + `</table>`;
}

function startTimer() {
  let time = 3 * 60 * 60;
  setInterval(() => {
    let h = Math.floor(time / 3600), m = Math.floor((time % 3600) / 60), s = time % 60;
    document.getElementById('timer').innerText = (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
    if (time > 0) time--;
  }, 1000);
}

function processData() {
  const testCode = mode === 'create' ? document.getElementById('create_test_code').value : document.getElementById('solve_test_code').value;
  const subject = mode === 'create' ? document.getElementById('subject_select').value : "ok";
  if (!testCode) return alert("Kodni kiriting!");

  const results = {};
  const row_configs = {}; // Har bir savol nechta javobdan iboratligi
  let emptyQuestions = [];

  for (let i = 1; i <= currentTotalQ; i++) {
    let row = document.getElementById(`row_${i}`);
    row.classList.remove('unanswered');
    if (i <= 35) {
      const sel = document.querySelector(`input[name="q${i}"]:checked`);
      results[i] = sel ? sel.value : "";
      if (!results[i]) { emptyQuestions.push(i); row.classList.add('unanswered'); }
    } else {
      let count = rowAnsCounts[i] || 1;
      row_configs[i] = count;
      let subValues = [];
      for(let j=0; j<count; j++) {
          let v = document.getElementById(`ans${i}_${j}`).value.trim();
          if(v) subValues.push(v);
      }
      if (subValues.length < count) { emptyQuestions.push(i); row.classList.add('unanswered'); }
      results[i] = subValues.join('|');
    }
  }

  if (emptyQuestions.length > 0) {
    alert("Barcha savollarni to'ldiring!");
    return;
  }

  tg.sendData(JSON.stringify({
    type: mode,
    test_code: testCode,
    subject: mode === 'create' ? subject : "",
    keys: results,
    total: currentTotalQ,
    configs: row_configs // Bu botga boradi va bot solve rejimida shunga qarab render qiladi
  }));
  tg.close();
}
</script>
</body>
</html>
