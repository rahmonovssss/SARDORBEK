<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Milliy Sertifikat Bot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root { --bg:#121920; --card:#1c2329; --accent:#00b4d8; --border:#2d3842; --text:#fff; }
body { font-family:-apple-system,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:15px; }
.header { text-align:center; margin-bottom:20px; font-size:20px; font-weight:bold; border-bottom:1px solid var(--border); padding-bottom:10px; }
.card { background:var(--card); padding:15px; border-radius:10px; border:1px solid var(--border); margin-bottom:15px; }
.hidden { display:none; }
.btn { background:var(--accent); color:#fff; border:none; padding:15px; width:100%; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; }
.timer { position:sticky; top:0; background:#e63946; padding:8px; text-align:center; font-weight:bold; border-radius:5px; margin-bottom:10px; }
table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); }
th,td { border:1px solid var(--border); padding:10px 5px; text-align:center; }
.opt-grid { display:flex; justify-content:center; gap:8px; }
.opt-item { position:relative; width:24px; height:24px; }
.opt-item input { position:absolute; opacity:0; width:100%; height:100%; margin:0; cursor:pointer; }
.checkmark { position:absolute; top:0; left:0; height:22px; width:22px; border:2px solid #55606a; border-radius:50%; }
.opt-item input:checked ~ .checkmark { background:var(--accent); border-color:var(--accent); }
.yopiq-field { background:#0d1217; border:1px solid var(--border); color:white; padding:10px; border-radius:5px; width:90%; margin:4px 0; text-align:center; }
.unanswered { border:2px solid #ff4d4d !important; }
</style>
</head>
<body>

<div class="header" id="title">Milliy Sertifikat Bot</div>

<div id="solve-init" class="card hidden">
<input type="number" id="solve_test_code" placeholder="Test kodini kiriting">
<button class="btn" onclick="startSolving()">OK</button>
</div>

<div id="test-area" class="hidden">
<div id="timer" class="timer hidden">03:00:00</div>
<div id="questions_table"></div>
<button class="btn" onclick="processData()">YUBORISH</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const urlParams = new URLSearchParams(window.location.search);
const mode = urlParams.get('mode') || 'solve';

let currentTotalQ = parseInt(urlParams.get('total')) || 45;
let rowAnsCounts = {};
let testMap = {};

try {
  const testRaw = urlParams.get('test_data');
  if (testRaw) testMap = JSON.parse(decodeURIComponent(testRaw));
} catch(e){}

try {
  const confRaw = urlParams.get('configs');
  if (confRaw) rowAnsCounts = JSON.parse(decodeURIComponent(confRaw));
} catch(e){}

for(let i=36;i<=45;i++){
  if(!rowAnsCounts[i]) rowAnsCounts[i]=1;
}

if(mode==="solve"){
  document.getElementById("solve-init").classList.remove("hidden");
}

function startSolving(){

  const code = document.getElementById("solve_test_code").value;
  if(!code) return alert("Kodni kiriting!");

  const subject = testMap[code];
  if(!subject) return alert("Test topilmadi!");

  document.getElementById("solve-init").classList.add("hidden");
  document.getElementById("test-area").classList.remove("hidden");
  document.getElementById("timer").classList.remove("hidden");

  renderQuestions();
  startTimer();
}

function renderQuestions(){

  let html=`<table><tr><th>â„–</th><th>Javob</th></tr>`;

  for(let i=1;i<=currentTotalQ;i++){

    if(i<=35){

      const cols=i<=32?['A','B','C','D']:['A','B','C','D','E','F'];

      html+=`<tr id="row_${i}">
      <td><b>${i}</b></td>
      <td><div class="opt-grid">`;

      cols.forEach(opt=>{
        html+=`
        <div class="opt-item">
        <input type="radio" name="q${i}" value="${opt}">
        <span class="checkmark"></span>
        </div>`;
      });

      html+=`</div></td></tr>`;

    }else{

      let count=rowAnsCounts[i]||1;

      html+=`<tr id="row_${i}">
      <td><b>${i}</b></td>
      <td>`;

      for(let j=0;j<count;j++){
        html+=`<input type="text" id="ans${i}_${j}" class="yopiq-field" placeholder="Javob ${count>1?j+1:''}">`;
      }

      html+=`</td></tr>`;
    }
  }

  document.getElementById("questions_table").innerHTML=html+"</table>";
}

function startTimer(){
  let time=3*60*60;
  setInterval(()=>{
    let h=Math.floor(time/3600);
    let m=Math.floor((time%3600)/60);
    let s=time%60;
    document.getElementById("timer").innerText=
    (h<10?'0'+h:h)+":"+
    (m<10?'0'+m:m)+":"+
    (s<10?'0'+s:s);
    if(time>0) time--;
  },1000);
}

function processData(){

  let results={};
  let empty=[];

  for(let i=1;i<=currentTotalQ;i++){

    let row=document.getElementById(`row_${i}`);
    row.classList.remove("unanswered");

    if(i<=35){

      const sel=document.querySelector(`input[name="q${i}"]:checked`);
      if(!sel){ empty.push(i); row.classList.add("unanswered"); }
      results[i]=sel?sel.value:"";

    }else{

      let count=rowAnsCounts[i]||1;
      let arr=[];

      for(let j=0;j<count;j++){
        let v=document.getElementById(`ans${i}_${j}`).value.trim();
        if(v) arr.push(v);
      }

      if(arr.length<count){
        empty.push(i);
        row.classList.add("unanswered");
      }

      results[i]=arr.join("|");
    }
  }

  if(empty.length>0){
    alert("Barcha savollarni to'ldiring!");
    return;
  }

  tg.sendData(JSON.stringify({
    test_code: document.getElementById("solve_test_code").value,
    keys: results,
    total: currentTotalQ,
    configs: rowAnsCounts
  }));

  tg.close();
}
</script>
</body>
</html>
